version: 1.0
runtime: python311
build:
  commands:
    pre-build:
      - echo "Installing uv package manager..."
      - curl -LsSf https://astral.sh/uv/install.sh | sh
      - export PATH="/root/.cargo/bin:$PATH"
      - echo "Python version:"
      - python --version
    build:
      - echo "Installing dependencies with uv..."
      - uv pip install --system -e .
      - uv pip install --system -e ".[s3]"
    post-build:
      - echo "Build completed successfully"
      - echo "Installed packages:"
      - pip list | grep -E "(fastapi|uvicorn|pymongo|pydantic)"

run:
  runtime-version: "3.11"
  command: uvicorn putplace.main:app --host 0.0.0.0 --port 8000 --workers 2
  network:
    port: 8000
    env: APP_PORT
  env:
    # MongoDB configuration from AWS Secrets Manager
    - name: MONGODB_URL
      value-from:
        type: secret
        name: putplace/mongodb
        key: MONGODB_URL
    - name: MONGODB_DATABASE
      value-from:
        type: secret
        name: putplace/mongodb
        key: MONGODB_DATABASE
    - name: MONGODB_COLLECTION
      value-from:
        type: secret
        name: putplace/mongodb
        key: MONGODB_COLLECTION

    # Admin user configuration from AWS Secrets Manager
    - name: PUTPLACE_ADMIN_USERNAME
      value-from:
        type: secret
        name: putplace/admin
        key: PUTPLACE_ADMIN_USERNAME
    - name: PUTPLACE_ADMIN_EMAIL
      value-from:
        type: secret
        name: putplace/admin
        key: PUTPLACE_ADMIN_EMAIL
    - name: PUTPLACE_ADMIN_PASSWORD
      value-from:
        type: secret
        name: putplace/admin
        key: PUTPLACE_ADMIN_PASSWORD

    # AWS and API configuration from AWS Secrets Manager
    - name: AWS_DEFAULT_REGION
      value-from:
        type: secret
        name: putplace/aws-config
        key: AWS_DEFAULT_REGION
    - name: API_TITLE
      value-from:
        type: secret
        name: putplace/aws-config
        key: API_TITLE
    - name: API_VERSION
      value-from:
        type: secret
        name: putplace/aws-config
        key: API_VERSION
    - name: PYTHONUNBUFFERED
      value-from:
        type: secret
        name: putplace/aws-config
        key: PYTHONUNBUFFERED
    - name: PYTHONDONTWRITEBYTECODE
      value-from:
        type: secret
        name: putplace/aws-config
        key: PYTHONDONTWRITEBYTECODE

health-check:
  protocol: http
  path: /health
  interval: 10
  timeout: 5
  healthy-threshold: 1
  unhealthy-threshold: 5
