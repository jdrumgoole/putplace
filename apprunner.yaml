version: 1.0
runtime: python311
build:
  commands:
    pre-build:
      - echo "Installing uv package manager..."
      - curl -LsSf https://astral.sh/uv/install.sh | sh
      - export PATH="/root/.cargo/bin:$PATH"
      - echo "Python version:"
      - python --version
    build:
      - echo "Installing dependencies with uv..."
      - uv pip install --system -e .
      - uv pip install --system -e ".[s3]"
    post-build:
      - echo "Build completed successfully"
      - echo "Installed packages:"
      - pip list | grep -E "(fastapi|uvicorn|pymongo|pydantic)"

run:
  runtime-version: "3.11"
  command: uvicorn putplace.main:app --host 0.0.0.0 --port 8000 --workers 2
  network:
    port: 8000
    env: APP_PORT
  env:
    - name: PYTHONUNBUFFERED
      value: "1"
    - name: PYTHONDONTWRITEBYTECODE
      value: "1"
    - name: API_TITLE
      value: "PutPlace File Metadata API"
    - name: API_VERSION
      value: "0.5.8"
    # MongoDB connection - set in App Runner console or AWS Secrets Manager
    # - name: MONGODB_URL
    #   value: "mongodb://your-mongodb-host:27017"
    # - name: MONGODB_DATABASE
    #   value: "putplace"
    # - name: MONGODB_COLLECTION
    #   value: "file_metadata"
    # AWS region for SES (if using email features)
    # - name: AWS_DEFAULT_REGION
    #   value: "eu-west-1"

health-check:
  protocol: http
  path: /health
  interval: 10
  timeout: 5
  healthy-threshold: 1
  unhealthy-threshold: 5
